<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esc√°ner QR</title>
    <style>
        .container {
            margin-top: 1em;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 90vh;
            position: relative;
        }
        .viewport {
            display: inline-block;
            position: relative;
            max-height: 100%;
        }
        video, canvas {
            max-width: 100%;
            max-height: 100%;
        }
        #canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .button-container, .zoom-button-container {
            position: absolute;
            text-align: center;
        }
        .button-container {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }
        .zoom-button-container {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
        }
        .button.zoom {
            padding: 5px 10px;
            font-size: 14px;
            margin: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .button.switch {
            padding: 10px 20px;
            font-size: 16px;
        }
        .button:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <audio id="beep" src="./beep-07a.mp3"></audio>
    <div class="container">
        <div class="viewport">
            <canvas id="canvas"></canvas>
            <video id="video" muted autoplay playsinline></video>
        </div>
        <div class="button-container">
            <button class="button switch" onclick="switchCamera()">Mudar Camera</button>
        </div>
        <div class="zoom-button-container">
            <button class="button zoom" onclick="zoomIn()">+</button>
            <button class="button zoom" onclick="zoomOut()">-</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@undecaf/zbar-wasm@0.11.0/dist/index.js"></script>
    <script>
        const el = {};
        let lastResultText = '';
        let currentStream;
        let currentFacingMode = 'environment';
        let currentZoom = 1;
        let offCanvas, requestId = null;

        document.querySelectorAll('[id]').forEach(element => el[element.id] = element);
        const beepSound = document.getElementById('beep');

        function isOffscreenCanvasWorking() {
            try {
                return typeof OffscreenCanvas !== 'undefined' && 
                       new OffscreenCanvas(1, 1).getContext('2d');
            } catch {
                return false;
            }
        }

        function detect(source) {
            const canvas = el.canvas;
            const ctx = canvas.getContext('2d');
            canvas.width = source.videoWidth || source.width;
            canvas.height = source.videoHeight || source.height;

            if (!canvas.width || !canvas.height) return Promise.resolve();

            ctx.drawImage(source, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            return zbarWasm.scanImageData(imageData).then(symbols => {
                symbols.forEach(symbol => {
                    ctx.beginPath();
                    ctx.moveTo(symbol.points[0].x, symbol.points[0].y);
                    symbol.points.forEach(point => ctx.lineTo(point.x, point.y));
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#00e00060';
                    ctx.stroke();
                });

                const resultText = symbols.map(m => m.decode("utf-8")).join();
                if (resultText && resultText !== lastResultText) {
                    window.parent.postMessage(resultText, '*');
                    lastResultText = resultText;
                    beepSound.play();
                }
            });
        }

        function detectVideo(active) {
            if (active) {
                detect(el.video).then(() => {
                    requestId = requestAnimationFrame(() => detectVideo(true));
                });
            } else {
                cancelAnimationFrame(requestId);
                requestId = null;
            }
        }

        function start(facingMode = 'environment') {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({ video: { facingMode } })
                .then(stream => {
                    currentStream = stream;
                    el.video.srcObject = stream;
                    detectVideo(true);
                })
                .catch(console.error);
        }

        function switchCamera() {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            start(currentFacingMode);
        }

        function setZoom(zoom) {
            if (currentStream) {
                const [track] = currentStream.getVideoTracks();
                if (track.getCapabilities().zoom) {
                    track.applyConstraints({ advanced: [{ zoom }] });
                    currentZoom = zoom;
                }
            }
        }

        function zoomIn() {
            if (currentStream) {
                const [track] = currentStream.getVideoTracks();
                const { zoom } = track.getCapabilities();
                if (zoom) setZoom(Math.min(zoom.max, currentZoom + 1));
            }
        }

        function zoomOut() {
            if (currentStream) {
                const [track] = currentStream.getVideoTracks();
                const { zoom } = track.getCapabilities();
                if (zoom) setZoom(Math.max(zoom.min, currentZoom - 1));
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            start();
        });
    </script>
</body>
</html>
